<div class="min-h-screen bg-gray-50 p-8">
  <div class="max-w-4xl mx-auto">
    <div class="mb-6">
      <p-button
        label="Back to Templates"
        icon="pi pi-arrow-left"
        severity="secondary"
        (onClick)="onBack()"
      />
    </div>

    @if (loading()) {
      <p-card>
        <p-skeleton width="60%" height="2rem" styleClass="mb-4" />
        <p-skeleton width="100%" height="10rem" styleClass="mb-4" />
        <p-skeleton width="40%" height="1.5rem" />
      </p-card>
    }

    @if (error()) {
      <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded mb-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <i class="pi pi-exclamation-triangle mr-2"></i>
            {{ error() }}
          </div>
          <p-button
            label="Retry"
            size="small"
            severity="danger"
            (onClick)="loadTemplate(template()?.id || '')"
          />
        </div>
      </div>
    }

    @if (!loading() && !error() && template()) {
      <div class="space-y-6">
        <p-card>
          <ng-template pTemplate="header">
            <div class="flex justify-between items-center p-6 pb-0">
              <h2 class="text-2xl font-bold text-gray-900">{{ template()!.name }}</h2>
              <p-button
                label="Edit Template"
                icon="pi pi-pencil"
                (onClick)="onEdit()"
              />
            </div>
          </ng-template>

          <div class="space-y-4">
            <div>
              <h3 class="text-sm font-semibold text-gray-700 mb-2">Content</h3>
              <div class="bg-gray-50 p-4 rounded border border-gray-200">
                <div [innerHTML]="template()!.content" class="prose max-w-none text-gray-900"></div>
              </div>
            </div>

            @if (getVariablesArray(template()!.variables).length > 0) {
              <div>
                <h3 class="text-sm font-semibold text-gray-700 mb-2">Variables</h3>
                <div class="flex flex-wrap gap-2">
                  @for (variable of getVariablesArray(template()!.variables); track variable) {
                    <p-tag [value]="variable" severity="secondary" />
                  }
                </div>
              </div>
            }

            <div class="flex items-center text-sm text-gray-500">
              <i class="pi pi-calendar mr-2"></i>
              <span>Created: {{ template()!.createdAt | date:'MMM d, y, h:mm a' }}</span>
            </div>
          </div>
        </p-card>

        <p-card>
          <ng-template pTemplate="header">
            <div class="p-6 pb-0">
              <h3 class="text-xl font-semibold text-gray-900">Generate Certificate</h3>
            </div>
          </ng-template>

          <form [formGroup]="certificateForm" (ngSubmit)="onGenerateCertificate()" class="space-y-4">
            @for (variable of getVariablesArray(template()!.variables); track variable) {
              <div class="flex flex-col gap-2">
                <p-floatlabel variant="on">
                  <input
                    pInputText
                    [id]="variable"
                    [formControlName]="variable"
                    class="w-full"
                    [class.ng-invalid]="certificateForm.get(variable)?.invalid && certificateForm.get(variable)?.touched"
                    [class.ng-dirty]="certificateForm.get(variable)?.touched"
                  />
                  <label [for]="variable">{{ variable }}</label>
                </p-floatlabel>
                @if (certificateForm.get(variable)?.invalid && certificateForm.get(variable)?.touched) {
                  <small class="text-red-600">{{ variable }} is required</small>
                }
              </div>
            }

            <div class="flex justify-end">
              <p-button
                type="submit"
                label="Generate Certificate"
                icon="pi pi-file-pdf"
                [loading]="generatingCertificate()"
                [disabled]="certificateForm.invalid || generatingCertificate()"
              />
            </div>
          </form>
        </p-card>
      </div>
    }

    <p-dialog
      [visible]="showEditDialog()"
      (visibleChange)="showEditDialog.set($event)"
      [modal]="true"
      [closable]="true"
      [draggable]="false"
      header="Edit Template"
      [style]="{width: '50vw'}"
      appendTo="body">
      <form [formGroup]="editTemplateForm" (ngSubmit)="onSaveEdit()" class="space-y-6">
        <div class="flex flex-col gap-2">
          <p-floatlabel variant="on">
            <input
              pInputText
              id="editName"
              formControlName="name"
              class="w-full"
              [class.ng-invalid]="editName?.invalid && editName?.touched"
              [class.ng-dirty]="editName?.touched"
            />
            <label for="editName">Template Name</label>
          </p-floatlabel>
          @if (editName?.invalid && editName?.touched) {
            <small class="text-red-600">
              @if (editName?.errors?.['required']) {
                Template name is required
              }
              @if (editName?.errors?.['minlength']) {
                Template name must be at least 3 characters
              }
            </small>
          }
        </div>

        <div class="flex flex-col gap-2">
          <label for="editContent" class="font-medium text-gray-700">Template Content</label>
          <p-editor
            id="editContent"
            formControlName="content"
            [style]="{'height':'320px'}"
            placeholder="Enter template content with placeholders like {name}, {date}, etc."
          />
          @if (editContent?.invalid && editContent?.touched) {
            <small class="text-red-600">Template content is required</small>
          }
        </div>

        @if (editErrorMessage()) {
          <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded">
            {{ editErrorMessage() }}
          </div>
        }

        <div class="flex justify-end gap-2">
          <p-button
            type="button"
            label="Cancel"
            severity="secondary"
            (onClick)="showEditDialog.set(false)"
          />
          <p-button
            type="submit"
            label="Save Changes"
            [loading]="editLoading()"
            [disabled]="editTemplateForm.invalid || editLoading()"
          />
        </div>
      </form>
    </p-dialog>
  </div>
</div>
