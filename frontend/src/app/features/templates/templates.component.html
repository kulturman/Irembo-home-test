<div class="p-8">
  <div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Certificate Templates</h1>
      <div class="flex gap-2">
        <p-button
          label="Create Template"
          icon="pi pi-plus"
          (onClick)="openCreateDialog()"></p-button>
      </div>
    </div>

    @if (error()) {
      <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded mb-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <i class="pi pi-exclamation-triangle mr-2"></i>
            {{ error() }}
          </div>
          <p-button
            label="Retry"
            size="small"
            severity="danger"
            (onClick)="loadTemplates()"
          />
        </div>
      </div>
    }

    @if (loading()) {
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        @for (item of [1,2,3,4,5,6]; track item) {
          <p-card>
            <p-skeleton width="60%" height="2rem" />
            <p-skeleton width="100%" height="4rem" styleClass="mt-4" />
            <div class="flex justify-between mt-4">
              <p-skeleton width="30%" height="1.5rem" />
              <p-skeleton width="20%" height="1.5rem" />
            </div>
          </p-card>
        }
      </div>
    }

    @if (!loading() && !error()) {
      @if (templates().length === 0) {
        <div class="text-center py-12">
          <i class="pi pi-file text-6xl text-gray-300"></i>
          <h3 class="text-xl font-semibold text-gray-600 mt-4">
            No Templates Found
          </h3>
          <p class="text-gray-500 mt-2">
            Get started by creating your first certificate template
          </p>
          <p-button
            label="Create Template"
            icon="pi pi-plus"
            (onClick)="openCreateDialog()"
            styleClass="mt-4"
          />
        </div>
      } @else {
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          @for (template of templates(); track template.id) {
            <p-card [style]="{'cursor': 'pointer'}" (click)="onViewTemplate(template.id)">
              <ng-template pTemplate="header">
                <div class="flex justify-between items-start p-4 pb-0">
                  <h3 class="text-xl font-semibold text-gray-900">
                    {{ template.name }}
                  </h3>
                </div>
              </ng-template>

              <div class="space-y-3">
                <div class="text-gray-600 text-sm">
                  {{ getContentPreview(template.content) }}
                </div>

                @if (template.variables && getVariablesArray(template.variables).length > 0) {
                  <div class="flex flex-wrap gap-1">
                    @for (variable of getVariablesArray(template.variables); track variable) {
                      <p-tag
                        [value]="variable"
                        severity="secondary"
                      />
                    }
                  </div>
                }

                <div class="flex items-center text-xs text-gray-500">
                  <i class="pi pi-calendar mr-1"></i>
                  <span>{{ template.createdAt | date:'MMM d, y' }}</span>
                </div>
              </div>

              <ng-template pTemplate="footer">
                <div class="flex gap-2">
                  <p-button
                    label="View Details"
                    icon="pi pi-eye"
                    severity="secondary"
                    size="small"
                    [style]="{'flex': '1'}"
                  />
                </div>
              </ng-template>
            </p-card>
          }
        </div>
      }
    }

    <p-dialog
      [(visible)]="showCreateDialog"
      [modal]="true"
      [closable]="true"
      [draggable]="false"
      header="Create New Template"
      [style]="{width: '50vw'}"
      appendTo="body">
      <form [formGroup]="createTemplateForm" (ngSubmit)="onCreateTemplate()" class="space-y-6">
        <div class="flex flex-col gap-2">
          <p-floatlabel variant="on">
            <input
              pInputText
              id="name"
              formControlName="name"
              class="w-full"
              [class.ng-invalid]="name?.invalid && name?.touched"
              [class.ng-dirty]="name?.touched"
            />
            <label for="name">Template Name</label>
          </p-floatlabel>
          @if (name?.invalid && name?.touched) {
            <small class="text-red-600">
              @if (name?.errors?.['required']) {
                Template name is required
              }
              @if (name?.errors?.['minlength']) {
                Template name must be at least 3 characters
              }
            </small>
          }
        </div>

        <div class="flex flex-col gap-2">
          <label for="content" class="font-medium text-gray-700">Template Content</label>
          <p-editor
            id="content"
            formControlName="content"
            [style]="{'height':'320px'}"
            placeholder="Enter template content with placeholders like {name}, {date}, etc."
          />
          @if (content?.invalid && content?.touched) {
            <small class="text-red-600">Template content is required</small>
          }
        </div>

        @if (createErrorMessage) {
          <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded">
            {{ createErrorMessage }}
          </div>
        }

        <div class="flex justify-end gap-2">
          <p-button
            type="button"
            label="Cancel"
            severity="secondary"
            (onClick)="showCreateDialog = false"
          />
          <p-button
            type="submit"
            label="Create Template"
            [loading]="createLoading"
            [disabled]="createTemplateForm.invalid || createLoading"
          />
        </div>
      </form>
    </p-dialog>
  </div>
</div>
